# ReadCassandraFromCluster

  Создание спарк-кластера на вирт.машинах(ВМ).

У меня комп на 4х ядрах\16гиг памяти\SSD 130G, поэтому выделил на каждую ВМ по 4гига\1ядро\20гиг.
Версия Убунты 16.04 LTS

1. Скачиваем VirtualBox.

https://www.virtualbox.org/wiki/Linux_Downloads


Подводный камень!  
Для каждой версии Убунту – свой ВиртуалБокс.

Я выбрал Убунту 14.04 LTS, потому что она старая надежная и проверенная мною лично. К тому же не жрет много памяти, а у меня SSD-шка всего 130 гиг, а свободного места всего 60Г. Если у тебя другие предпочтения и есть ресурс, то выбирай свою версию. 



2. Скачали\установили\запустили.
Такой синий кубик.

Подводный камень.  
Возможна такая проблема. При создании новой машины в меню выбора ОС  нет 64-битных систем. Вот 32-бита есть, а 64 нет. Ни для Винды, ни для Линукса.
 Для этого нужно в Биосе поставить 

Virtualization Technology  enabled 
VT-d Feature                       enabled 

Если у тебя это всё в биосе как-то по-другому, набери гугле “virtualbox only 32 bit available”  - много ссылок.

3. Скачиваем исошник соответствующей убунты.
Для 14.04  это http://releases.ubuntu.com/14.04/

4. Создаем ВМ
   - name : spark1
   - type : Linux
   - version : Ubuntu (64bit)
   - memory size : 4G
 - create a virtual hard disk now – VDI – dynamicaly alocated – 20G

5. Настройки

- система :  убери флопик
- дисплей : 128м видео память
- storage:
   тут внимательно
  Под контроллером ИДЕ есть сидишник и написано Empty.
На этом сидишнике клац и справа от Optical drive - IDE Secondary Master появится сидишник. 
На нем клац. Выбрать исошник Убунты, который скачали в п.3

6. Network
               NAT

7. Shared folders.
    Выбери папку для расшаривания. Я выбрал Music.


--------------- Всё готово для первого запуска ------

8. Start

Устанавливаешь Убунту.

Во время установки

Machine name: spark1VM

User        : scalaspark

Password    :  scalaspark

перезагрузка

9. Install  s

- стартуешь ВМ 
- вверху десктопа ВМ есть меню File-Machine-View-Input-Devices
-  клацаешь Devices
-  в самом внизу меню выбираешь  Insert Guest Additions CD image 
- устанавливаешь этот софт
- перезагрузка.

10. Ставишь Джаву 8


11. Прописывешь джава-хоум

export JAVA_HOME=/usr/lib/jvm/java-8.0-openjdk-amd64

export PATH=$PATH:JAVA_HOME

или какие там у тебя пути




12. Устанавливаешь SSH

$ sudo apt-get install openssh-server

$ ssh-keygen -t rsa -P "" при запросе файлнейм -  Энтер

$ cat $HOME/.ssh/id_rsa.pub >> $HOME/.ssh/authorized_keys

$ chmod 0600 /home/scalaspark/.ssh/authorized_keys

проверяешь связь с локалхостом

$ ssh localhost

должен увидеть что-то типа

Welcome to Ubuntu ...


$ logout

13. Устанавливаешь Спарк

http://spark.apache.org/downloads.html

скачиваешь, разархивируешь, переименовуешь








14. Настройка слейвов

В папке spark/conf есть файл slaves.template 
его переименовать просто в  slaves.

Добавить две строки 

spark1VM
spark2VM

Второй ВМ ещё не создали, а в списке уже есть. Так надо.

15. Shut down ВМ.

16. В менеджере ВМ клацни правой кнопкой мыши на созданной ВМ. В меню выбери Clone. Назови её spark2.
Внимание! Не spark2VM, а именно  spark2.

17. Полный клон. Reinitialize the MAC

18. Стартуешь вторую ВМ, которая  spark2.

19. Заходишь в /etc/hostname и переименовуешь 
spark1VM в spark2VM

20. Рестарт. 

21. Теперь конфигурирование обоих слейвов. Стартуешь первую ВМ тоже. Следующие операции сделать в обеих ВМ.

22. Правый верхний угол ВМ. Там где иконки времени, языка, громкости и сети.

Клацаешь на сети. У меня это две стрелки вверх-вниз.

Смотришь какой текущий айпишник. Это Connection Information.  Или ifcofig в терминале. 

У меня это 192.168.56.4  Надо на него ориентироваться для     присваивания ай-пишников ВМ.

Внизу   Edit conections - Add
Type: Ethernet
Device MAC: select eth0
IPv4 Settings:
Method: Manual
Add Address: 
192.168.56.5 для spark1 и 
192.168.56.10 для spark2
Netmask: 255.255.255.0
Gateway: 192.168.56.1
DNS: 8.8.8.8

Этому соединению дай соотв. Название, например, connection-spark.

Лучше перезагрузить ВМ, чтобы в силу вступили изменения.

23. Выбрать именно это соединение в правом верхнем углу для этих двух ВМ.

  

24. Вставить в обеих ВМ /etc/hosts

127.0.0.1     localhost
192.168.56.5  spark1VM
192.168.56.10 spark2VM

25. Проверяем спарк. Стартуем мастера с spark1VM

  ~/spark/sbin/start-all.sh

Смотрим в браузере localhost:8080

Видим обе ВМ.

Подводные камни.  У меня почему-то вышло на десктопе, но не вышло на нотике. Ещё разбираюсь. 
Надо проверять взаимосвязь  этих ВМ (link together).
А именно с ВМ spark2VM запустить $ ssh spark1VM.
И наоборот. $ ssh spark2VM


26. Теперь надо залить бинарник на ВМ.  Это тоже не так просто.
  Ну вот я задекларировал, что у меня Shared folder будет Music. Также спецом для этого проинсталил VBOXADDITIONS.
Смотрю в Devices - там есть фолдер sf_Music. Но открыть его не удается – This location could not be displayed.

Нужно добавить пользователя в  'vboxsf'

В терминале

~$echo $USER; 

spark1VM

~$ ~$ sudo usermod -a -G vboxsf spark1VM

Теперь можно в папку Music  залить бинарник, и он будет виден в ВМ.




27. Теперь можно попробовать что-то запустить на кластере.

Перекидываем бинарник на spark1VM  
Например, прога поиска числа Пи.

И запускаем.

./spark-submit --deploy-mode cluster --class "Pi2" --master spark://spark1VM:7077 Pi2_2.11-1.0.jar 

28. Запустить прогу по Кассандре – ещё не делал. Всё ещё борюсь с утечкой памяти. См. Код.



